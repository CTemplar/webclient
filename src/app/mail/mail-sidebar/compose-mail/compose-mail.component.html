<div class="mail-composer-body">
  <form>
    <div class="mail-compose-field-group">
      <!-- 'From' field -->
      <div class="mail-compose-field">
        <span class="mail-label label-from">{{ 'settings.compose.from' | translate }}</span>
        <div class="col-sm p-0">
          <div class="btn-dropdown btn-dropdown-select btn-dropdown-lg">
            <div ngbDropdown class="dropdown-sm">
              <button
                ngbDropdownToggle
                class="dropdown-toggle border-0 from-text"
                id="fromEmailDropdownMenuButton"
                role="button"
                [disabled]="attachments?.length > 0"
              >
                <app-composer-encryption-type-icon
                  [isAutocrypt]="true"
                  [autocryptInfo]="autocryptInfo"
                ></app-composer-encryption-type-icon>
                <!--                <app-composer-encryption-type-icon [isAutocrypt]="true" [isAutocryptEncrypt]="true" [autocryptInfo]="autocryptInfo"></app-composer-encryption-type-icon>-->
                {{ selectedMailbox?.email | emailFormat: selectedMailbox?.display_name }}
              </button>
              <div
                *ngIf="!attachments || attachments.length === 0"
                ngbDropdownMenu
                class="from-dropdown"
                aria-labelledby="fromEmailDropdownMenuButton"
              >
                <ng-container *ngFor="let mailbox of mailBoxesState?.mailboxes">
                  <a
                    class="dropdown-item from-text"
                    *ngIf="mailbox.is_enabled"
                    (click)="onFromChanged(mailbox, selectedMailbox)"
                    >{{ mailbox.email }}</a
                  >
                </ng-container>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- 'From' field -->
      <!-- 'To' field -->
      <div class="mail-compose-field mail-compose-field-to" #receiverInput>
        <span class="mail-label label-to">{{ 'settings.compose.to' | translate }}</span>
        <tag-input
          [(ngModel)]="mailData.receiver"
          *ngIf="isLoaded"
          name="to"
          [placeholder]="' '"
          [secondaryPlaceholder]="'settings.compose.recipient_email' | translate"
          [onTextChangeDebounce]="100"
          [onlyFromAutocomplete]="false"
          [addOnBlur]="true"
          [editable]="true"
          [separatorKeys]="[',']"
          [separatorKeyCodes]="[13]"
          [(inputText)]="inputTextValue"
          (onAdd)="onAddingReceiver($event, mailData.receiver)"
          (onRemove)="handleRemoveRecipient('receiver')"
          [addOnPaste]="true"
          (onTagEdited)="onTagEdited($event)"
          (click)="onClick()"
          #input
        >
          <ng-template let-item="item" let-index="index">
            <app-circle-bar-spinner
              [showSpinner]="getUserKeyFetchingStatus(item.email)"
              [color]="night_mode ? '#fff' : '#333333'"
            ></app-circle-bar-spinner>
            <app-receiver-email-chip
              [contacts]="clonedContacts"
              [email]="item.email"
              [isContactEncrypted]="userState.settings.is_contacts_encrypted"
              [blacklist]="blacklist"
              [whitelist]="whitelist"
              [autocryptInfo]="autocryptInfo"
              [encryptionTypeMap]="receiverEncryptTypeMap"
            ></app-receiver-email-chip>
            <delete-icon (click)="input.removeItem(item, index)"></delete-icon>
          </ng-template>
          <tag-input-dropdown
            [showDropdownIfEmpty]="false"
            [appendToBody]="false"
            [displayBy]="'display'"
            [identifyBy]="'email'"
            [autocompleteItems]="contacts"
          >
            <ng-template let-item="item" let-index="index">
              <div class="compose-contacts-container">
                <img src="assets/images/user-icon-grey.png" alt="user-image" />
                <div class="compose-contacts-userinfo">
                  <div>{{ item.name }}</div>
                  <div>{{ item.email }}</div>
                </div>
              </div>
            </ng-template>
          </tag-input-dropdown>
        </tag-input>
        <div class="extra-mail-label">
          <span class="mail-label mail-floated-label" (click)="options.isCcVisible = !options.isCcVisible">Cc</span>
          <span class="mail-label mail-floated-label mr-0" (click)="options.isBccVisible = !options.isBccVisible"
            >Bcc</span
          >
        </div>
      </div>
      <!-- 'To' field -->
      <!-- 'Cc' field -->
      <div class="mail-compose-field" [ngClass]="{ 'd-none': !options.isCcVisible }" #ccReceiverInput>
        <span class="mail-label label-cc">Cc:</span>
        <tag-input
          [(ngModel)]="mailData.cc"
          name="cc"
          [placeholder]="' '"
          [secondaryPlaceholder]="'settings.compose.cc_email' | translate"
          [onTextChangeDebounce]="100"
          [onlyFromAutocomplete]="false"
          [addOnBlur]="true"
          [editable]="true"
          [separatorKeys]="[',']"
          [separatorKeyCodes]="[13]"
          [(inputText)]="ccInputTextValue"
          (onAdd)="onAddingReceiver($event, mailData.cc)"
          (onRemove)="handleRemoveRecipient('ccReceiver')"
          [addOnPaste]="true"
          (onTagEdited)="ccOnTagEdited($event)"
          (click)="onCcClick()"
          #ccInput
        >
          <ng-template let-item="item" let-index="index">
            <app-circle-bar-spinner
              [showSpinner]="getUserKeyFetchingStatus(item.email)"
              [color]="night_mode ? '#fff' : '#333333'"
            ></app-circle-bar-spinner>
            <app-receiver-email-chip
              [contacts]="clonedContacts"
              [email]="item.email"
              [isContactEncrypted]="userState.settings.is_contacts_encrypted"
              [blacklist]="blacklist"
              [whitelist]="whitelist"
              [autocryptInfo]="autocryptInfo"
              [encryptionTypeMap]="receiverEncryptTypeMap"
            ></app-receiver-email-chip>
            <delete-icon (click)="ccInput.removeItem(item, index)"></delete-icon>
          </ng-template>
          <tag-input-dropdown
            [showDropdownIfEmpty]="false"
            [appendToBody]="false"
            [displayBy]="'display'"
            [identifyBy]="'email'"
            [autocompleteItems]="contacts"
          >
            <ng-template let-item="item" let-index="index">
              <div class="compose-contacts-container">
                <img src="assets/images/user-icon-grey.png" alt="user-image" />
                <div class="compose-contacts-userinfo">
                  <div>{{ item.name }}</div>
                  <div>{{ item.email }}</div>
                </div>
              </div>
            </ng-template>
          </tag-input-dropdown>
        </tag-input>
      </div>
      <!-- 'Cc' field -->
      <!-- 'Bcc' field -->
      <div class="mail-compose-field" [ngClass]="{ 'd-none': !options.isBccVisible }" #bccReceiverInput>
        <span class="mail-label label-bcc">Bcc:</span>
        <tag-input
          [(ngModel)]="mailData.bcc"
          name="bcc"
          [placeholder]="' '"
          [secondaryPlaceholder]="'settings.compose.bcc_email' | translate"
          [onTextChangeDebounce]="100"
          [onlyFromAutocomplete]="false"
          [addOnBlur]="true"
          [editable]="true"
          [separatorKeys]="[',']"
          [separatorKeyCodes]="[13]"
          [(inputText)]="bccInputTextValue"
          (onAdd)="onAddingReceiver($event, mailData.bcc)"
          (onRemove)="handleRemoveRecipient('bccReceiver')"
          [addOnPaste]="true"
          (onTagEdited)="bccOnTagEdited($event)"
          (click)="onBccClick()"
          #bccInput
        >
          <ng-template let-item="item" let-index="index">
            <app-circle-bar-spinner
              [showSpinner]="getUserKeyFetchingStatus(item.email)"
              [color]="night_mode ? '#fff' : '#333333'"
            ></app-circle-bar-spinner>
            <app-receiver-email-chip
              [contacts]="clonedContacts"
              [email]="item.email"
              [isContactEncrypted]="userState.settings.is_contacts_encrypted"
              [blacklist]="blacklist"
              [whitelist]="whitelist"
              [autocryptInfo]="autocryptInfo"
              [encryptionTypeMap]="receiverEncryptTypeMap"
            ></app-receiver-email-chip>
            <delete-icon (click)="bccInput.removeItem(item, index)"></delete-icon>
          </ng-template>
          <tag-input-dropdown
            [showDropdownIfEmpty]="false"
            [appendToBody]="false"
            [displayBy]="'display'"
            [identifyBy]="'email'"
            [autocompleteItems]="contacts"
          >
            <ng-template let-item="item" let-index="index">
              <div class="compose-contacts-container">
                <img src="assets/images/user-icon-grey.png" alt="user-image" />
                <div class="compose-contacts-userinfo">
                  <div>{{ item.name }}</div>
                  <div>{{ item.email }}</div>
                </div>
              </div>
            </ng-template>
          </tag-input-dropdown>
        </tag-input>
      </div>
      <!-- 'Bcc' field -->
      <!-- 'Subject' field -->
      <div class="mail-compose-field">
        <span class="mail-label label-subject mail-subject">{{ 'settings.compose.subject' | translate }}</span>
        <input
          type="text"
          class="mail-compose-control"
          name="subject"
          [(ngModel)]="mailData.subject"
          (ngModelChange)="valueChanged$.next(mailData.subject); onSubjectChange(mailData.subject)"
          id="subject"
        />
      </div>
      <!-- 'Subject' field -->
    </div>
  </form>
  <!-- Main Content field -->
  <div class="mail-compose-editable-body">
    <div class="mail-compose-box has-custom-scroll" id="editor-cover-scroller">
      <div class="mail-compose-box-inner">
        <div class="mail-compose-editable-box" (drop)="onFilesDrop($event)">
          <ckeditor
            #composerEditorElementRef
            id="editor"
            class="editor"
            *ngIf="draftMail?.is_html"
            [editor]="DecoupledEditor"
            (ready)="onEditorReady($event)"
          ></ckeditor>

          <div *ngIf="!draftMail?.is_html">
            <textarea
              class="plain-editor"
              name="content"
              [(ngModel)]="mailData.content"
              (ngModelChange)="valueChanged$.next(mailData.content)"
              id="content"
              rows="1"
              [ngStyle]="{ 'font-family': settings.plain_text_font ? settings.plain_text_font : 'monospace' }"
            >
            </textarea>
          </div>
        </div>
        <input
          type="file"
          #imageInput
          accept="image/*"
          multiple
          (change)="onImagesSelected($event.target.files)"
          style="display: none"
        />
        <input type="file" #fileInput multiple (change)="onFilesSelected($event.target.files)" style="display: none" />
        <div class="attach-uploader-holder" *ngIf="attachments?.length > 0">
          <ng-container *ngFor="let file of attachments">
            <div class="attach-uploader" *ngIf="!file.isRemoved && !(file.is_inline && file.progress === 100)">
              <div class="attach-name">
                <div class="file-name">{{ file.name }}</div>
                <div class="attach-size" *ngIf="file.size">({{ file.size }})</div>
              </div>
              <div class="progress" *ngIf="file.progress !== 100">
                <div
                  class="progress-bar"
                  role="progressbar"
                  [style.width]="file.progress + '%'"
                  [attr.aria-valuenow]="file.progress"
                  aria-valuemin="0"
                  aria-valuemax="100"
                ></div>
              </div>
              <button
                type="button"
                role="button"
                (click)="removeAttachment(file)"
                class="attach-uploader-close"
                placement="top"
                [ngbTooltip]="'settings.remove' | translate"
              >
                <i class="icon icon-cross"></i>
              </button>
            </div>
          </ng-container>
        </div>
        <div #attachmentHolder style="height: 30px"></div>
      </div>
    </div>
    <div class="mail-composer-footer">
      <div class="mail-composer-actions-row d-flex">
        <div
          class="mail-composer-actions-col mail-composer-actions-col-lg"
          [ngClass]="{ 'composer-footer': !isFullScreen && !isMailDetailPage }"
        >
          <ul class="mail-composer-actions d-flex align-items-center">
            <!-- Send button -->
            <li class="send-mail-item">
              <button
                class="btn btn-sm btn-secondary btn-mail-send btn-xs-rounded"
                (click)="sendEmailCheck()"
                [disabled]="this.isPreparingToSendEmail || isUploadingAttachment || isDownloadingAttachmentCounter > 0"
                role="button"
                placement="top"
              >
                <i class="hidden-sm-up icon icon-paper-plane"></i>
                <span class="hidden-xs-down">{{
                  isPreparingToSendEmail
                    ? ('settings.compose.processing' | translate)
                    : ('settings.compose.send' | translate)
                }}</span>
              </button>
            </li>
            <!-- Text formatting -->
            <li class="pr-0">
              <div
                *ngIf="!draftMail?.is_html; else textFormatter"
                ngbTooltip="Text formatting is not available in plain text editor"
                class="dropdown"
              >
                <button class="actions-btn mail-typo-btn hide-arrow" disabled>
                  <i class="icon icon-text-color"></i>
                </button>
              </div>
              <ng-template #textFormatter>
                <div ngbDropdown [autoClose]="'outside'" [placement]="['top-left', 'bottom-left']" class="dropdown">
                  <button
                    ngbDropdownToggle
                    class="actions-btn mail-typo-btn hide-arrow"
                    id="typoDropdownMenu"
                    role="button"
                    placement="top"
                    [ngbTooltip]="'settings.compose.text_format' | translate"
                  >
                    <i class="icon icon-text-color"></i>
                  </button>
                  <div ngbDropdownMenu class="typo-actions-dropdown-menu" aria-labelledby="typoDropdownMenu">
                    <div
                      #toolbar
                      id="toolbar"
                      class="mail-comopser-typo-actions-holder toolbar-container ckeditor-composer-toolbar-container"
                    >
                      <div class="reset-font-button-container">
                        <button
                          type="button"
                          role="button"
                          class="btn-link"
                          ngbTooltip="Set setting's default fonts"
                          (click)="onSetSettingFont()"
                        >
                          <i class="fas fa-sync-alt"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </ng-template>
            </li>
            <!-- Attachments -->
            <li class="p-0">
              <button
                type="button"
                role="button"
                (click)="fileInput.value = ''; fileInput.click()"
                class="actions-btn mail-attach-btn"
                placement="top"
                [ngbTooltip]="'settings.compose.attachments' | translate"
              >
                <i class="icon icon-attachment"></i>
              </button>
            </li>
            <!-- Insert Link -->
            <li class="p-0">
              <div
                *ngIf="!draftMail?.is_html; else insertLinkRef"
                ngbTooltip="Insert link is not available in plain text editor"
                class="dropdown"
              >
                <button class="actions-btn insert-link-btn" disabled>
                  <i class="fas fa-link"></i>
                </button>
              </div>
              <ng-template #insertLinkRef>
                <button
                  role="button"
                  ngbTooltip="Insert link"
                  (click)="openInsertLinkModal()"
                  class="actions-btn insert-link-btn"
                >
                  <i class="fas fa-link"></i>
                </button>
              </ng-template>
            </li>
            <!-- Insert Image -->
            <li class="p-0">
              <div
                *ngIf="!draftMail?.is_html; else insertImageRef"
                ngbTooltip="Insert Image is not available in plain text editor"
                class="dropdown"
              >
                <button class="actions-btn mail-attach-image-btn" disabled>
                  <i class="icon fa fa-image"></i>
                </button>
              </div>
              <ng-template #insertImageRef>
                <button
                  role="button"
                  ngbTooltip="Insert Image"
                  (click)="onInsertImage()"
                  class="actions-btn mail-attach-image-btn"
                >
                  <i class="icon fa fa-image"></i>
                </button>
              </ng-template>
            </li>
            <!-- Encryption -->
            <li class="p-0" [ngbTooltip]="'page_pricing.encryption' | translate">
              <button
                role="button"
                type="button"
                class="actions-btn mail-envelop-btn border-radius-r-0"
                [ngClass]="{ 'text-primary': draftMail?.encryption?.password }"
                (click)="openEncryptionModal()"
                placement="top"
                [ngbTooltip]="'settings.compose.encryption' | translate"
              >
                <i class="icon icon-mail"></i>
              </button>
            </li>
            <!-- Self Destruct-->
            <li
              class="p-0"
              *ngIf="
                (userState?.isPrime || isTrialPrimeFeaturesAvailable) && isSelfDestruction;
                else disabledSelfDestructBtn
              "
            >
              <button
                role="button"
                type="button"
                (click)="openSelfDestructModal()"
                class="actions-btn mail-clock-btn border-left-0 border-radius-0"
                [ngClass]="{ 'badge badge-warning text-white': selfDestruct.value }"
                placement="top"
                [ngbTooltip]="'settings.compose.self_destr_timer' | translate"
              >
                <i class="icon icon-clock"></i>
              </button>
            </li>
            <ng-template #disabledSelfDestructBtn>
              <li
                class="px-0"
                *ngIf="userState?.isPrime || isTrialPrimeFeaturesAvailable; else upgradeAccount"
                ngbTooltip="Self Destruction is only for Ctemplar recipients. Please add ctemplar recipients for self destruction feature"
              >
                <button
                  type="button"
                  role="button"
                  class="actions-btn mail-clock-btn border-left-0 border-radius-0"
                  disabled
                >
                  <i class="icon icon-clock"></i>
                </button>
              </li>
              <ng-template #upgradeAccount>
                <li class="px-0" ngbTooltip="Upgrade account to use Self Destruct Email feature">
                  <button
                    type="button"
                    role="button"
                    class="actions-btn mail-clock-btn border-left-0 border-radius-0"
                    disabled
                  >
                    <i class="icon icon-clock"></i>
                  </button>
                </li>
              </ng-template>
            </ng-template>
            <!-- Delayed Delivery -->
            <li
              class="p-0"
              *ngIf="userState?.isPrime || isTrialPrimeFeaturesAvailable; else disabledDelayedDeliveryBtn"
            >
              <button
                type="button"
                role="button"
                (click)="openDelayedDeliveryModal()"
                class="actions-btn mail-self-timer-btn border-left-0 border-radius-l-0"
                [ngClass]="{ 'badge badge-success text-white': delayedDelivery.value }"
                placement="top"
                [ngbTooltip]="'settings.compose.delayed_delivery' | translate"
              >
                <i class="icon icon-self-timer"></i>
              </button>
            </li>
            <ng-template #disabledDelayedDeliveryBtn>
              <li class="p-0" ngbTooltip="Upgrade account to use Delayed Delivery feature.">
                <button
                  type="button"
                  role="button"
                  class="actions-btn mail-self-timer-btn border-left-0 border-radius-l-0"
                  disabled
                >
                  <i class="icon icon-self-timer"></i>
                </button>
              </li>
            </ng-template>
            <!-- Dead man Timer -->
            <li class="p-0" *ngIf="userState?.isPrime || isTrialPrimeFeaturesAvailable; else disabledDeadManTimerBtn">
              <button
                type="button"
                role="button"
                (click)="openDeadManTimerModal()"
                class="actions-btn mail-dead-btn border-left-0 border-radius-l-0"
                [ngClass]="{ 'badge badge-danger text-white': deadManTimer.value }"
                placement="top"
                [ngbTooltip]="'settings.compose.dead_man_timer' | translate"
              >
                <i class="icon icon-dead"></i>
              </button>
            </li>
            <ng-template #disabledDeadManTimerBtn>
              <li class="p-0" ngbTooltip="Upgrade account to use Dead Man Timer feature.">
                <button
                  type="button"
                  role="button"
                  class="actions-btn mail-dead-btn border-left-0 border-radius-l-0"
                  disabled
                >
                  <i class="icon icon-dead"></i>
                </button>
              </li>
            </ng-template>
            <!-- More button(version change) -->
            <li class="btn-dropdown">
              <div
                ngbDropdown
                [autoClose]="'outside'"
                class="dropdown menu-btn"
                [placement]="['top-left', 'bottom-left']"
              >
                <button
                  class="actions-btn more-btn hide-arrow"
                  id="btn_more"
                  [ngbTooltip]="'More'"
                  placement="right"
                  ngbDropdownToggle
                >
                  <i class="fa fa-ellipsis-v"></i>
                </button>
                <div ngbDropdownMenu class="dropdown-menu-right text-center" aria-labelledby="btn_more">
                  <button
                    class="dropdown-item dropdown-menu-item"
                    (click)="setHtmlEditor(true)"
                    [disabled]="draftMail.is_html || pgpEncryptionType === 'PGP_INLINE'"
                  >
                    <div class="row-item">
                      <div class="check-box">
                        <i *ngIf="draftMail.is_html" class="fa fa-check text-black-50 ng-star-inserted"></i>
                      </div>
                      <a class="ql-size-small" target="_blank" rel="noopener noreferrer"> HTML Editor</a>
                    </div>
                  </button>
                  <button
                    class="dropdown-item dropdown-menu-item"
                    (click)="setHtmlEditor(false)"
                    [disabled]="!draftMail.is_html"
                  >
                    <div class="row-item">
                      <div class="check-box">
                        <i *ngIf="!draftMail.is_html" class="fa fa-check text-black-50 ng-star-inserted"></i>
                      </div>
                      <a class="ql-size-small">Plain Text</a>
                    </div>
                  </button>
                  <button
                    class="dropdown-item dropdown-menu-item dropdown-menu-item-attach"
                    (click)="onClickAttachPublicKey(!selectedMailbox?.is_attach_public_key)"
                  >
                    <div class="row-item">
                      <div class="check-box">
                        <i
                          *ngIf="selectedMailbox?.is_attach_public_key"
                          class="fa fa-check text-black-50 ng-star-inserted"
                        ></i>
                      </div>
                      <a class="ql-size-small" [translate]="'settings.security.attach_public_key'">Attach public key</a>
                    </div>
                  </button>
                  <button
                    class="dropdown-item dropdown-menu-item dropdown-menu-item-attach"
                    (click)="onClickSignMessage(!selectedMailbox?.is_pgp_sign)"
                  >
                    <div class="row-item">
                      <div class="check-box">
                        <i *ngIf="selectedMailbox?.is_pgp_sign" class="fa fa-check text-black-50 ng-star-inserted"></i>
                      </div>
                      <a class="ql-size-small" [translate]="'common.sign_message'">Sign message</a>
                    </div>
                  </button>
                </div>
              </div>
            </li>
          </ul>
        </div>
        <!-- save/delete button field on footer -->
        <div
          class="mail-composer-actions-col mail-composer-actions-col-sm"
          [ngClass]="{ 'composer-footer': !isFullScreen && !isMailDetailPage }"
        >
          <ul class="mail-composer-actions d-flex align-items-center justify-content-end">
            <li class="pr-1" *ngIf="isDownloadingAttachmentCounter > 0">
              <span>{{ 'settings.compose.downloading_attachments' | translate }}</span>
            </li>
            <li class="pr-1" *ngIf="inProgress || (draftMail && draftMail.id)">
              <span>{{
                inProgress
                  ? draftMail.send
                    ? ('settings.compose.sending' | translate)
                    : ('settings.compose.saving' | translate)
                  : ('settings.compose.saved' | translate)
              }}</span>
            </li>
            <li class="pr-0" *ngIf="showSaveButton">
              <button
                role="button"
                (click)="saveInDrafts()"
                [disabled]="isUploadingAttachment || isDownloadingAttachmentCounter > 0"
                class="actions-btn mail-save-disk-btn border-right-0 border-radius-r-0"
                placement="top"
                [ngbTooltip]="'settings.compose.save_to_drafts' | translate"
              >
                <i class="icon icon-save-disk"></i>
              </button>
            </li>
            <li class="pl-0">
              <button
                role="button"
                (click)="discardEmail()"
                [disabled]="!draftMail.id || isUploadingAttachment || isDownloadingAttachmentCounter > 0"
                class="actions-btn mail-garbage-btn border-radius-l-0"
                placement="top"
                [ngbTooltip]="'settings.compose.delete_draft' | translate"
              >
                <i class="icon icon-garbage"></i>
              </button>
            </li>
            <li class="pl-0 pop-up-reply" *ngIf="isMailDetailPage">
              <button
                role="button"
                (click)="openReplyinPopup()"
                [disabled]="inProgress || isUploadingAttachment || isDownloadingAttachmentCounter > 0"
                class="actions-btn border-radius-l-0"
                placement="top"
                [ngbTooltip]="'Pop out reply'"
              >
                <i class="fas fa-external-link-alt"></i>
              </button>
            </li>
          </ul>
        </div>
        <!-- save/delete button field on footer -->
      </div>
    </div>
  </div>
  <!-- Main Content field -->

  <!-- attach images modal -->
  <ng-template #attachImagesModal let-c="close" let-d="dismiss">
    <div class="modal-header">
      <h3 class="modal-title w-100 text-dark">
        <strong>{{ 'settings.compose.attach_images' | translate }}</strong>
      </h3>
      <button type="button" class="close" data-dismiss="modal" aria-label="Close" (click)="d()">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    <div class="modal-body bg-faded">
      <div class="mail-actions-form-holder modal-mail-actions-form-holder">
        <div class="form-group">{{ 'settings.compose.select_file' | translate }}</div>
        <div class="form-group">
          <label for="imageURL">Image URL</label>
          <input
            type="text"
            #imageURL
            id="imageURL"
            class="form-control"
            [placeholder]="'settings.compose.image_url' | translate"
          />
        </div>
        <div class="form-group text-right mb-0">
          <button
            type="button"
            (click)="imageInput.value = ''; imageInput.click(); d()"
            class="btn btn-success btn-sm mr-1"
            role="button"
          >
            <span>{{ 'settings.compose.attach_files' | translate }}</span>
          </button>
          <button type="button" (click)="onAttachImageURL(imageURL.value)" class="btn btn-success btn-sm" role="button">
            <span>{{ 'settings.compose.attach_url' | translate }}</span>
          </button>
        </div>
      </div>
    </div> </ng-template
  ><!-- /.attach images modal ends -->

  <!-- self destruct datetime picker modal -->
  <ng-template #selfDestructModal let-c="close" let-d="dismiss">
    <div class="modal-header">
      <h3 class="modal-title w-100 text-dark">
        <strong>{{ 'settings.compose.self_dest_email' | translate }}</strong>
        <ng-container
          [ngTemplateOutlet]="learnMore"
          [ngTemplateOutletContext]="{ link: 'https://ctemplar.com/help/answer/using-the-self-destruct-timer/' }"
        >
        </ng-container>
      </h3>
      <button type="button" class="close" data-dismiss="modal" aria-label="Close" (click)="d()">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    <div class="modal-body bg-faded">
      <div class="mail-actions-form-holder modal-mail-actions-form-holder">
        <div class="form-group">{{ 'settings.compose.email_deleted' | translate }} ({{ settings.timezone }})</div>
        <div class="row">
          <div class="col-7 form-group">
            <label class="form-inline">{{ 'settings.compose.select_date' | translate }}</label>
            <ngb-datepicker
              class="bg-white ng-datepicker ng-datepicker-265"
              ngbAutofocus
              [(ngModel)]="selfDestruct.date"
              [minDate]="datePickerMinDate"
              (ngModelChange)="changeSelfDestruct()"
            >
            </ngb-datepicker>
          </div>
          <div class="col-5 form-group">
            <label class="form-inline">{{ 'settings.compose.select_time' | translate }}</label>
            <ngb-timepicker
              [(ngModel)]="selfDestruct.time"
              [meridian]="selfDestruct.meridian"
              (ngModelChange)="changeSelfDestruct()"
            ></ngb-timepicker>
          </div>
        </div>
        <label class="form-group"
          >{{ 'mail_detail.delete_in' | translate }} {{ selfDestructTimeString | remainingTime }}</label
        >
        <div *ngIf="selfDestruct.error" class="l-alert l-alert-danger mb-3">{{ selfDestruct.error }}</div>
        <div class="form-group text-center btns-xs-3 mb-0">
          <button type="button" (click)="setSelfDestructValue()" class="btn btn-success btn-sm mr-1" role="button">
            <span>{{ 'settings.compose.confirm' | translate }}</span>
          </button>
          <button type="button" (click)="clearSelfDestructValue()" class="btn btn-primary btn-sm mr-1" role="button">
            Clear
          </button>
          <button (click)="d()" class="btn btn-secondary btn-sm" role="button">
            {{ 'common.cancel' | translate }}
          </button>
        </div>
      </div>
    </div> </ng-template
  ><!-- /.self destruct datetime picker modal ends -->

  <!-- delayed delivery datetime picker modal -->
  <ng-template #delayedDeliveryModal let-c="close" let-d="dismiss">
    <div class="modal-header">
      <h3 class="modal-title w-100 text-dark">
        <strong>{{ 'settings.compose.delayed_delivery' | translate }}</strong>
        <ng-container
          [ngTemplateOutlet]="learnMore"
          [ngTemplateOutletContext]="{
            link: 'https://ctemplar.com/help/answer/delay-or-schedule-sending-email-messages/'
          }"
        >
        </ng-container>
      </h3>
      <button type="button" class="close" data-dismiss="modal" aria-label="Close" (click)="d()">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    <div class="modal-body bg-faded">
      <div class="mail-actions-form-holder modal-mail-actions-form-holder">
        <div class="form-group">{{ 'settings.compose.email_on_datetime' | translate }} ({{ settings.timezone }})</div>
        <div class="row">
          <div class="col-7 form-group">
            <label class="form-inline">{{ 'settings.compose.select_date' | translate }}</label>
            <ngb-datepicker
              class="bg-white ng-datepicker ng-datepicker-265"
              ngbAutofocus
              [(ngModel)]="delayedDelivery.date"
              [minDate]="datePickerMinDate"
              (ngModelChange)="changeDelayDeliver()"
            ></ngb-datepicker>
          </div>
          <div class="col-5 form-group">
            <label class="form-inline">{{ 'settings.compose.select_time' | translate }}</label>
            <ngb-timepicker
              [(ngModel)]="delayedDelivery.time"
              [meridian]="delayedDelivery.meridian"
              (ngModelChange)="changeDelayDeliver()"
            ></ngb-timepicker>
          </div>
        </div>
        <label class="form-group"
          >{{ 'mail_detail.delay_delivery' | translate }} {{ delayDeliverTimeString | remainingTime }}</label
        >
        <div *ngIf="delayedDelivery.error" class="l-alert l-alert-danger mb-3">{{ delayedDelivery.error }}</div>
        <div class="form-group text-center btns-xs-3 mb-0">
          <button type="button" (click)="setDelayedDeliveryValue()" class="btn btn-success btn-sm mr-1" role="button">
            {{ 'settings.compose.confirm' | translate }}
          </button>
          <button type="button" (click)="clearDelayedDeliveryValue()" class="btn btn-primary btn-sm mr-1" role="button">
            {{ 'settings.compose.clear' | translate }}
          </button>
          <button (click)="d()" class="btn btn-secondary btn-sm" role="button">
            {{ 'common.cancel' | translate }}
          </button>
        </div>
      </div>
    </div> </ng-template
  ><!-- /.delayed delivery datetime picker modal ends -->

  <!-- dead man timer modal -->
  <ng-template #deadManTimerModal let-c="close" let-d="dismiss">
    <div class="modal-header">
      <h3 class="modal-title w-100 text-dark">
        <strong>{{ 'settings.compose.dead_man_timer' | translate }}</strong>
        <ng-container
          [ngTemplateOutlet]="learnMore"
          [ngTemplateOutletContext]="{ link: 'https://ctemplar.com/help/answer/setting-up-a-dead-mans-timer/' }"
        >
        </ng-container>
      </h3>
      <button type="button" class="close" data-dismiss="modal" aria-label="Close" (click)="d()">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    <div class="modal-body bg-faded">
      <div class="mail-actions-form-holder modal-mail-actions-form-holder">
        <div class="form-group">{{ 'settings.compose.email_sent_timer' | translate }}</div>
        <form (submit)="setDeadManTimerValue()">
          <div class="form-group">
            <label class="form-inline" for="deadman-days">{{ 'settings.compose.days' | translate }}</label>
            <input
              type="number"
              class="form-control"
              id="deadman-days"
              name="deadman-days"
              ngbAutofocus
              [(ngModel)]="deadManTimer.days"
            />
          </div>
          <div class="form-group">
            <label class="form-inline" for="deadman-hours">{{ 'settings.compose.hours' | translate }}</label>
            <input
              type="number"
              class="form-control"
              id="deadman-hours"
              name="deadman-hours"
              [(ngModel)]="deadManTimer.hours"
            />
          </div>
          <div class="form-group text-center btns-xs-3 mb-0">
            <button type="submit" class="btn btn-success btn-sm mr-1" role="button">
              {{ 'settings.compose.confirm' | translate }}
            </button>
            <button type="reset" (click)="clearDeadManTimerValue()" class="btn btn-primary btn-sm mr-1" role="button">
              {{ 'settings.compose.clear' | translate }}
            </button>
            <button (click)="d()" class="btn btn-secondary btn-sm" role="button">
              {{ 'common.cancel' | translate }}
            </button>
          </div>
        </form>
      </div>
    </div> </ng-template
  ><!-- /.dead man timer modal ends -->

  <!-- Insert link modal -->
  <ng-template #insertLinkModal let-c="close" let-d="dismiss">
    <div class="modal-header">
      <h3 class="modal-title w-100 text-dark">
        <strong>{{ 'settings.compose.insert_link' | translate }}</strong>
      </h3>
      <button type="button" class="close" data-dismiss="modal" aria-label="Close" (click)="d()">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    <div class="modal-body bg-faded">
      <div class="mail-actions-form-holder modal-mail-actions-form-holder">
        <form (submit)="insertLink(insertLinkData.text, insertLinkData.link)">
          <div class="form-group">
            <label class="form-inline" for="text-to-display">{{
              'settings.compose.text_to_display' | translate
            }}</label>
            <input
              type="text"
              class="form-control"
              id="text-to-display"
              name="text-to-display"
              [(ngModel)]="insertLinkData.text"
            />
          </div>
          <div class="form-group">
            <label class="form-inline" for="link-to">{{ 'settings.compose.link_to' | translate }}</label>
            <input type="text" class="form-control" id="link-to" name="link-to" [(ngModel)]="insertLinkData.link" />
          </div>
          <div class="form-group text-center btns-xs-3 mb-0">
            <button (click)="d()" class="btn btn-secondary btn-sm" role="button">
              {{ 'common.cancel' | translate }}
            </button>
            <button
              type="submit"
              class="btn btn-success btn-sm ml-2"
              [disabled]="!insertLinkData.text || !insertLinkData.link"
              role="button"
            >
              OK
            </button>
          </div>
        </form>
      </div>
    </div> </ng-template
  ><!-- /.Insert link modal ends -->

  <!-- encryption modal -->
  <ng-template #encryptionModal let-c="close" let-d="dismiss">
    <div class="modal-header">
      <h3 class="modal-title w-100 text-dark">
        <strong>{{ 'settings.compose.encrypt_for_non' | translate }}</strong>
        <ng-container
          [ngTemplateOutlet]="learnMore"
          [ngTemplateOutletContext]="{
            link: 'https://ctemplar.com/help/answer/sending-encrypted-email-to-non-ctemplar-users/'
          }"
        >
        </ng-container>
      </h3>
      <button type="button" class="close" data-dismiss="modal" aria-label="Close" (click)="d()">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    <div class="modal-body bg-faded encrypt-non-ctemplar">
      <div class="mail-actions-form-holder modal-mail-actions-form-holder">
        <form [formGroup]="encryptForm" (submit)="onSubmitEncryption()">
          <div class="form-group">
            <label for="encrypt-password">{{ 'settings.compose.message_password' | translate }}</label>
            <div class="input-group">
              <input
                #encryptPasswordInput
                type="password"
                class="form-control form-control-lg"
                id="encrypt-password"
                ngbAutofocus
                formControlName="password"
                [placeholder]="'settings.compose.message_password' | translate"
              />
              <span
                class="input-group-addon password-toggle bg-white text-muted"
                (click)="encryptPasswordInput.type = encryptPasswordInput.type === 'password' ? 'text' : 'password'"
              >
                <i class="fa fa-eye"></i> <i class="fa fa-eye-slash"></i>
              </span>
            </div>
            <span *ngIf="encryptForm.controls['password'].errors && showEncryptFormErrors" class="validate-message">
              <span *ngIf="encryptForm.controls['password'].errors.required">
                {{ 'settings.compose.message_password_req' | translate }}
              </span>
            </span>
          </div>
          <div class="form-group">
            <label for="confirm-encrypt-password">{{ 'create_account.confirm_password' | translate }}</label>
            <div class="input-group">
              <input
                #encryptConfirmPasswordInput
                type="password"
                class="form-control form-control-lg"
                id="confirm-encrypt-password"
                formControlName="confirmPwd"
                [placeholder]="'create_account.confirm_password' | translate"
              />
              <span
                class="input-group-addon password-toggle bg-white text-muted"
                (click)="
                  encryptConfirmPasswordInput.type =
                    encryptConfirmPasswordInput.type === 'password' ? 'text' : 'password'
                "
              >
                <i class="fa fa-eye"></i>
                <i class="fa fa-eye-slash"></i>
              </span>
            </div>
            <span *ngIf="encryptForm.controls['confirmPwd'].errors && showEncryptFormErrors" class="validate-message">
              <span>{{ 'create_account.passwords_not_match' | translate }}</span>
            </span>
          </div>
          <div class="form-group">
            <label for="password-hint">{{ 'settings.compose.password_hint' | translate }}</label>
            <input
              type="text"
              id="password-hint"
              class="form-control"
              formControlName="passwordHint"
              [placeholder]="'settings.compose.password_hint' | translate"
            />
          </div>
          <div class="form-group">
            <label>{{ 'settings.compose.encrypt_message_expire' | translate }}</label>
            <div class="row">
              <div class="col-3">
                <label class="form-inline" for="encryption-expire-days">{{
                  'settings.compose.days' | translate
                }}</label>
                <input
                  type="number"
                  class="form-control"
                  formControlName="days"
                  min="0"
                  max="5"
                  name="encrypt-non-ctemplar-days"
                />
              </div>
              <div class="col-3">
                <label class="form-inline" for="encryption-expire-hours">{{
                  'settings.compose.hours' | translate
                }}</label>
                <input
                  type="number"
                  class="form-control"
                  formControlName="hours"
                  min="0"
                  max="24"
                  name="encrypt-non-ctemplar-hours"
                />
              </div>
            </div>
            <div>
              <span
                *ngIf="
                  showEncryptFormErrors &&
                  (encryptForm.controls['days'].errors ||
                    encryptForm.controls['hours'].errors ||
                    encryptForm.controls['hours'].value + encryptForm.controls['days'].value * 24 === 0 ||
                    encryptForm.controls['hours'].value + encryptForm.controls['days'].value * 24 > 120)
                "
                class="validate-message"
              >
                {{ 'settings.compose.expiry_time_message' | translate }}
              </span>
            </div>
          </div>
          <div class="form-group text-center mb-0">
            <button type="submit" class="btn btn-success btn-sm mr-1" role="button">
              {{ 'settings.compose.confirm' | translate }}
            </button>
            <button type="button" (click)="clearEncryption()" class="btn btn-primary btn-sm mr-1" role="button">
              {{ 'settings.compose.clear' | translate }}
            </button>
            <button (click)="d()" class="btn btn-secondary btn-sm" role="button">
              {{ 'common.cancel' | translate }}
            </button>
          </div>
        </form>
      </div>
    </div> </ng-template
  ><!-- /.encryption modal ends -->

  <!-- Modal -->
  <ng-template #subjectConfirmationModal let-c="close" let-d="dismiss">
    <div class="modal-header">
      <h3 class="modal-title w-100 text-dark">
        <strong [translate]="'settings.compose.confirm_send'">Confirm Send </strong>
      </h3>
      <button type="button" class="close" data-dismiss="modal" aria-label="Close" (click)="d()">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    <div class="modal-body bg-faded">
      <div class="mail-actions-form-holder modal-mail-actions-form-holder">
        <div class="form-group">
          <span>
            Are you sure, send this message without a subject ?</span>
        </div>
        <div class="form-group text-right mb-0">
          <button (click)="d()" class="btn btn-secondary btn-sm mr-2" role="button">
            <span [translate]="'common.cancel'">Cancel</span>
          </button>
          <button (click)="sendEmails()" class="btn btn-danger btn-sm" role="button" [disabled]="userState?.inProgress">
            <span [translate]="'settings.compose.send'">Send</span>
          </button>
          <app-loading-spinner [showSpinner]="userState?.inProgress"></app-loading-spinner>
        </div>
      </div>
    </div> </ng-template>

  <!-- End here -->
  <!-- Confirm send email without subject modal -->
  <ng-template #confirmationModal let-c="close" let-d="dismiss">
    <div class="modal-header">
      <h3 class="modal-title w-100 text-dark">
        <strong [translate]="'settings.compose.confirm_send'">Confirm Send </strong>
      </h3>
      <button type="button" class="close" data-dismiss="modal" aria-label="Close" (click)="d()">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    <div class="modal-body bg-faded">
      <div class="mail-actions-form-holder modal-mail-actions-form-holder">
        <div class="form-group">
          <span [translate]="'settings.compose.send_without_all'">
            Are you sure, send this message without a subject or text in the body?</span
          >
        </div>
        <div class="form-group text-right mb-0">
          <button (click)="d()" class="btn btn-secondary btn-sm mr-2" role="button">
            <span [translate]="'common.cancel'">Cancel</span>
          </button>
          <button (click)="sendEmail()" class="btn btn-danger btn-sm" role="button" [disabled]="userState?.inProgress">
            <span [translate]="'settings.compose.send'">Send</span>
          </button>
          <app-loading-spinner [showSpinner]="userState?.inProgress"></app-loading-spinner>
        </div>
      </div>
    </div> </ng-template
  ><!-- /.Confirm send email without subject modal ends -->
  <!-- Close Confirm modal -->
  <ng-template #closeConfirmationModal let-c="close" let-d="dismiss">
    <div class="modal-header">
      <h3 class="modal-title w-100 text-dark">
        <strong [translate]="'settings.compose.confirm_close'">Confirm Close</strong>
      </h3>
      <button type="button" class="close" data-dismiss="modal" aria-label="Close" (click)="d()">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    <div class="modal-body bg-faded">
      <div class="mail-actions-form-holder modal-mail-actions-form-holder">
        <div class="form-group">
          <span [translate]="'settings.compose.close_during_uploading'">
            Are you sure to close? the upload and encryption process will be lost if you close before uploading is not
            completed.</span
          >
        </div>
        <div class="form-group text-right mb-0">
          <button (click)="d()" class="btn btn-secondary btn-sm mr-2" role="button">
            <span [translate]="'common.cancel'">Cancel</span>
          </button>
          <button (click)="closeComposeConfirm()" class="btn btn-danger btn-sm" role="button">
            <span [translate]="'settings.compose.confirm'">Confirm</span>
          </button>
        </div>
      </div>
    </div> </ng-template
  ><!-- /.Close Confirm modal ends -->
  <ng-template #learnMore let-link="link">
    <a
      ngbTooltip="Learn more"
      target="_blank"
      rel="noreferrer noopener"
      class="learn-more-info-icon position-absolute"
      [href]="link"
      ><i class="far fa-question-circle"></i>
    </a>
  </ng-template>
</div>
